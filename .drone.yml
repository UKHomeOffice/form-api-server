## Build Image
kind: pipeline
name: default

steps:
- name: test
  image: digitalpatterns/node:4
  commands:
    - npm install
    - npm run cover
  when:
    event: push

- name: build_push_to_docker
  image: plugins/docker
  settings:
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
  repo: digitalpatterns/form-api-server
  tags:
    - ${DRONE_COMMIT_SHA}
  when:
    branch: master
    event: push

- name: deploy_to_elf
  image: quay.io/ukhomeofficedigital/kd
  secrets:
    - ELF_FORM_API_NAME
    - ELF_WHITELIST
    - ELF_FORM_API_KUBE_NAMESPACE
    - ELF_KUBE_SERVER
    - ELF_KUBE_TOKEN
    - ELF_FORM_API_DB_USERNAME
    - ELF_FORM_API_DB_PASSWORD
    - ELF_FORM_API_DB_HOSTNAME
    - ELF_FORM_API_DB_NAME
    - ELF_FORM_API_DB_PORT
    - ELF_FORM_API_DB_SSL
    - ELF_KEYCLOAK_URL
    - ELF_FORM_API_KEYCLOAK_CLIENT_ID
    - ELF_KEYCLOAK_REALM
    - ELF_FORM_API_KEYCLOAK_ADMIN_USERNAME
    - ELF_FORM_API_KEYCLOAK_ADMIN_PASSWORD
    - ELF_FORM_API_KEYCLOAK_ADMIN_ROLES
    - ELF_FORM_API_LOG_ENABLE_CHANGE
    - ELF_FORM_API_LOG_CHANGE_TIMEOUT
    - ELF_FORM_API_CORS_ORIGIN
    - ELF_FORM_API_ENABLE_QUERY
    - ELF_FORM_API_PORT
  commands:
    - export FORM_API_NAME=$${ELF_FORM_API_NAME}
    - export WHITELIST=$${ELF_WHITELIST}
    - export KUBE_NAMESPACE=$${ELF_FORM_API_KUBE_NAMESPACE}
    - export KUBE_SERVER=$${ELF_KUBE_SERVER}
    - export KUBE_TOKEN=$${ELF_KUBE_TOKEN}
    - export FORM_API_DB_USERNAME=$${ELF_FORM_API_DB_USERNAME}
    - export FORM_API_DB_PASSWORD=$${ELF_FORM_API_DB_PASSWORD}
    - export FORM_API_DB_HOSTNAME=$${ELF_FORM_API_DB_HOSTNAME}
    - export FORM_API_DB_NAME=$${ELF_FORM_API_DB_NAME}
    - export FORM_API_DB_PORT=$${ELF_FORM_API_DB_PORT}
    - export FORM_API_DB_SSL=$${ELF_FORM_API_DB_SSL}
    - export KEYCLOAK_URL=$${ELF_KEYCLOAK_URL}
    - export FORM_API_KEYCLOAK_CLIENT_ID=$${ELF_FORM_API_KEYCLOAK_CLIENT_ID}
    - export KEYCLOAK_REALM=$${ELF_KEYCLOAK_REALM}
    - export FORM_API_KEYCLOAK_ADMIN_USERNAME=$${ELF_FORM_API_KEYCLOAK_ADMIN_USERNAME}
    - export FORM_API_KEYCLOAK_ADMIN_PASSWORD=$${ELF_FORM_API_KEYCLOAK_ADMIN_PASSWORD}
    - export FORM_API_KEYCLOAK_ADMIN_ROLES=$${ELF_FORM_API_KEYCLOAK_ADMIN_ROLES}
    - export FORM_API_LOG_ENABLE_CHANGE=$${ELF_FORM_API_LOG_ENABLE_CHANGE}
    - export FORM_API_LOG_CHANGE_TIMEOUT=$${ELF_FORM_API_LOG_CHANGE_TIMEOUT}
    - export FORM_API_CORS_ORIGIN=$${ELF_FORM_API_CORS_ORIGIN}
    - export FORM_API_LOG_ENABLE_QUERY=$${ELF_FORM_API_LOG_ENABLE_QUERY}
    - export FORM_API_PORT=$${ELF_FORM_API_PORT}
    - export IMAGE_TAG=${DRONE_COMMIT_SHA}
    - kd --insecure-skip-tls-verify -f kube/secret.yml
    - kd --insecure-skip-tls-verify -f kube/network-policy.yml
    - kd --insecure-skip-tls-verify -f kube/service.yml
    - kd --insecure-skip-tls-verify -f kube/deployment.yml
    - kd --insecure-skip-tls-verify -f kube/ingress.yml
  when:
    environment: dev
    event: deployment
